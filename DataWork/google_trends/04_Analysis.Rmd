---
title: "04_Analysis"
output: html_document
---

```{r}
trends_df <- read.csv(file.path(dropbox_file_path, "Data/google_trends/FinalData/brazil_admin_trends_clean.csv"))
```

# Cleaning and creation of new variables
```{r}
trends_df <- trends_df %>% mutate(date = as.Date(date))
```

# We create categories for key words

```{r}
trends_df <- 
  trends_df %>% 
  mutate(
    categories = case_when(
      keyword %in% 
        c("abuso", "abuso sexual", "desemprego",  "dívida", "Educação online",
          "psicologia", "terapia" ) ~ "consequences",
      keyword %in% 
        c("cama de hospital", "desinfetantes", "hidroxicloroquina", 
          "máscara facial", "termômetros", "ventiladores") ~ "resources",
      keyword %in% 
        c( "dificuldade ao respirar", "dor nos olhos", "falta de cheiro", 
           "febre", "febre alta valor","perda de olfato", "tosse",
           "sintomas do coronavirus") ~ "symptoms",
      keyword %in% 
        c("distância social","fique em casa", "lavar as mãos") ~ "prevention", 
      keyword %in% c("coronavirus", "covid") ~ "virus"
      )
  )
```

# Create new variables: death rate, cases & deaths per 100,000

```{r}
trends_df <- 
  trends_df %>% 
  mutate(
    case_rate = cases*100000/estimate_2018_state, 
    death_rate = deaths*100000/estimate_2018_state, 
    fatalities_per_case = cases/deaths
  )

trends_df <- 
  trends_df %>% 
  mutate(fatalities_per_case = if_else(is.na(fatalities_per_case), 0, fatalities_per_case))
```

- check NAs for Rondonia and Santa Catalina


# Searches per state

Evolution of symptoms
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "symptoms") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```

Consequences
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "consequences") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```
Prevention
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "prevention") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```


Resources

```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "resources") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```


# Cases per state

Total number of cases across states
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(cases)) %>% 
  count(cases, date, state) %>% 
  ggplot() +
  geom_line(aes(date, cases, group = state, color = state)) 
```

Case rate per state
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(case_rate)) %>% 
  count(case_rate, date, state) %>% 
  ggplot() +
  geom_line(aes(date, case_rate, group = state, color = state)) 
```

Death rate per state
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(death_rate)) %>% 
  count(death_rate, date, state) %>% 
  ggplot() +
  geom_line(aes(date, death_rate, group = state, color = state)) 
```


# Cases and deaths at the regional level 
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(cases)) %>% 
  group_by(region, date) %>% 
  summarize(
    sum_cases_region = sum(cases, na.rm = TRUE), 
    sum_deaths_region = sum(deaths, na.rm = TRUE)
  ) %>% 
  pivot_longer(c(sum_cases_region, sum_deaths_region), names_to = "variable") %>% 
  ggplot() +
  geom_line(aes(date, value, group = region, color = region)) +
  facet_wrap(vars(variable), scales = "free")

```

# Cases and deaths at the state level 
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(cases)) %>% 
  group_by(state, date) %>% 
  summarize(
    sum_cases_state = sum(cases, na.rm = TRUE), 
    sum_deaths_state = sum(deaths, na.rm = TRUE)
  ) %>% 
  pivot_longer(c(sum_cases_state, sum_deaths_state), names_to = "variable") %>% 
  ggplot() +
  geom_line(aes(date, value, group = state, color = state)) +
  facet_wrap(vars(variable), scales = "free")
```

# We decide to focus on top 5 states in number of cases

```{r}
top_5_states <- 
  trends_df %>% 
  group_by(state) %>% 
  summarize(sum_cases = sum(cases, na.rm = TRUE)) %>% 
  arrange(desc(sum_cases)) %>% 
  head(5) %>% 
  mutate(state = as.character(state)) %>%
  pull(state)
```

Just checking the hits per keyword across states
```{r}
trends_df %>% 
  filter(state %in% top_5_states) %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  facet_wrap(vars(keyword))
```

We now change the focus to the state level, and see the correlations of each keyword with the number of cases
```{r}
trends_df %>% 
  filter(state %in% top_5_states) %>% 
  count(keyword, date, hits, state, cases) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = keyword, color = keyword)) + 
  geom_line(aes(date, cases)) +
  facet_wrap(vars(state), scales = "free") +
  coord_cartesian(ylim = c(0, 100))

trends_df %>% 
  filter(state %in% top_5_states, keyword %in% c("coronavirus", "febre", "tosse", "fique em casa")) %>% 
  count(keyword, date, hits, state, cases) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = keyword, color = keyword)) + 
  geom_line(aes(date, cases)) +
  facet_wrap(vars(state), scales = "free") +
  coord_cartesian(ylim = c(0, 100))
```


```{r}
trends_df %>% 
  count(keyword, date, hits, state, cases) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = keyword, color = keyword)) + 
  facet_wrap(vars(state), scales = "free") +
  geom_line(aes(date, cases)) +
  coord_cartesian(ylim = c(0, 100))
```

