---
title: "05_Analysis"
author: Manuel Ramos
output: 
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
    toc_fold: TRUE
---

```{r, include = FALSE}
library(tidyverse)
library(gridExtra)

#trends_df <- read.csv(file.path(dropbox_file_path, "Data/google_trends/FinalData/brazil_trends_clean_final.csv"))

trends_df <- read.csv("/Users/wb537287/Dropbox/COVID Social Media Analysis/Data/google_trends/FinalData/brazil_trends_clean_final.csv")

```

```{r}
trends_df <- trends_df %>% mutate(date = as.Date(date))
```

# Searches per state

Evolution of symptoms
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "symptoms") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```

Consequences
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "consequences") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```
Prevention
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "prevention") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```


Resources

```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(keyword), categories == "resources") %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  geom_smooth(aes(date, hits)) +
  facet_wrap(vars(keyword))
```


# Cases per state

Total number of cases across states
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(cases)) %>% 
  count(cases, date, state) %>% 
  ggplot() +
  geom_line(aes(date, cases, group = state, color = state)) 
```

Case rate per state
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(case_rate)) %>% 
  count(case_rate, date, state) %>% 
  ggplot() +
  geom_line(aes(date, case_rate, group = state, color = state)) 
```

Death rate per state
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(death_rate)) %>% 
  count(death_rate, date, state) %>% 
  ggplot() +
  geom_line(aes(date, death_rate, group = state, color = state)) 
```


# Cases and deaths at the regional level 
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(cases)) %>% 
  group_by(region, date) %>% 
  summarize(
    sum_cases_region = sum(cases, na.rm = TRUE), 
    sum_deaths_region = sum(deaths, na.rm = TRUE)
  ) %>% 
  pivot_longer(c(sum_cases_region, sum_deaths_region), names_to = "variable") %>% 
  ggplot() +
  geom_line(aes(date, value, group = region, color = region)) +
  facet_wrap(vars(variable), scales = "free")

```

# Cases and deaths at the state level 
```{r}
trends_df %>% 
  filter(!is.na(state), !is.na(cases)) %>% 
  group_by(state, date) %>% 
  summarize(
    sum_cases_state = sum(cases, na.rm = TRUE), 
    sum_deaths_state = sum(deaths, na.rm = TRUE)
  ) %>% 
  pivot_longer(c(sum_cases_state, sum_deaths_state), names_to = "variable") %>% 
  ggplot() +
  geom_line(aes(date, value, group = state, color = state)) +
  facet_wrap(vars(variable), scales = "free")
```

# States ordered by death and case rate on April 1st

```{r}
case_rate_per_state <- 
  trends_df %>% 
  filter(date == "2020-04-01", is.na(keyword) | keyword == "coronavirus") %>% 
  ggplot() +
  geom_col(aes(fct_reorder(state, case_rate), case_rate)) +
  coord_flip() +
  labs(x = "Cases per 100,000 people")

death_rate_per_state <- 
  trends_df %>% 
  filter(date == "2020-04-01", is.na(keyword) | keyword == "coronavirus") %>% 
  ggplot() +
  geom_col(aes(fct_reorder(state, death_rate), death_rate)) +
  coord_flip() +
  labs(x = "Deaths per 100,000 people")


fatality_per_case_state <- 
  trends_df %>% 
  filter(date == "2020-04-01", is.na(keyword) | keyword == "coronavirus") %>% 
  ggplot() +
  geom_col(aes(fct_reorder(state, fatalities_per_case), fatalities_per_case)) +
  coord_flip() + 
  labs(x = "Deaths per case")
  
grid.arrange(case_rate_per_state, death_rate_per_state, fatality_per_case_state, ncol = 3)
```

```{r}
top_5_case_rate <- 
  trends_df %>% 
  filter(date == "2020-04-01", is.na(keyword) | keyword == "coronavirus") %>% 
  arrange(desc(case_rate)) %>% 
  head(5) %>% pull(state)

top_5_death_rate <- 
  trends_df %>% 
  filter(date == "2020-04-01", is.na(keyword) | keyword == "coronavirus") %>% 
  arrange(desc(death_rate)) %>% 
  head(5) %>% pull(state)
```


# We focus on top 5 states in number of cases

```{r}
top_5_states <- 
  trends_df %>% 
  group_by(state) %>% 
  summarize(sum_cases = sum(cases, na.rm = TRUE)) %>% 
  arrange(desc(sum_cases)) %>% 
  head(5) %>% 
  mutate(state = as.character(state)) %>%
  pull(state)
```

Just checking the hits per keyword across states
```{r}
trends_df %>% 
  filter(state %in% top_5_states) %>% 
  count(keyword, date, hits, state) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = state, color = state)) + 
  facet_wrap(vars(keyword))
```

We now change the focus to the state level, and see the correlations of each keyword with the number of cases
```{r}
trends_df %>% 
  filter(state %in% top_5_states) %>% 
  count(keyword, date, hits, state, cases) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = keyword, color = keyword)) + 
  geom_line(aes(date, cases)) +
  facet_wrap(vars(state), scales = "free") +
  coord_cartesian(ylim = c(0, 100))
```

```{r}
trends_df %>% 
  filter(state %in% top_5_states, keyword %in% c("coronavirus", "febre", "tosse", "fique em casa") ) %>% 
  count(keyword, date, hits, state, cases) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = keyword, color = keyword)) + 
  geom_line(aes(date, cases)) +
  facet_wrap(vars(state), scales = "free") +
  coord_cartesian(ylim = c(0, 100))
```

- "fique em cassa" (stay at home) becomes popular after the increase in cases of coronavirus takes place.
- in contrast, the increase in popularity of "coronavirus", "tosse" and "febre" precedes the increase in actual cases. 

```{r}
trends_df %>% 
  count(keyword, date, hits, state, cases) %>% 
  ggplot() +
  geom_line(aes(date, hits, group = keyword, color = keyword)) + 
  facet_wrap(vars(state), scales = "free") +
  geom_line(aes(date, cases)) +
  coord_cartesian(ylim = c(0, 100))
```


# Group by category, see the time lag between the average of the category and the case rate

```{r}
sum_cases_date <- 
  trends_df %>% 
  filter(!is.na(state), !is.na(cases), is.na(keyword) | keyword == "coronavirus") %>% 
  group_by(date) %>% 
  summarize(
    cases_total = sum(cases, na.rm = TRUE), 
    cases_mean = mean(cases, na.rm = TRUE), 
    deaths_total = sum(deaths, na.rm = TRUE), 
    deaths_mean = mean(deaths, na.rm = TRUE), 
  )

trends_df %>% 
  filter(!is.na(categories)) %>% 
  group_by(categories, date) %>% 
  summarize(
    mean_hits = mean(hits, na.rm = TRUE)
  ) %>% 
  ggplot() + 
  geom_line(aes(date, mean_hits, group = categories, color = categories)) +
  geom_line(data = sum_cases_date, aes(date, cases_total)) +
  geom_line(data = sum_cases_date, aes(date, deaths_total)) +
  coord_cartesian(ylim = c(0, 100))
  
```

```{r}
trends_df %>% 
  filter(!is.na(categories), state %in% top_5_case_rate, categories != "consequences") %>% 
  group_by(categories, state, date) %>% 
  mutate(
    mean_hits = mean(hits, na.rm = TRUE)
  ) %>% 
  ggplot() + 
  geom_line(aes(date, mean_hits, group = categories, color = categories)) +
  geom_line(aes(date, cases)) +
  coord_cartesian(ylim = c(0, 100)) + 
  facet_wrap(vars(state))
```

- people start to google about the virus and about symptoms around the time when the number of cases in Sao Paulo starts to increase. 
- the search of those terms in the rest of states increases as well, so these searcehs

```{r}
trends_df %>% 
  filter(!is.na(categories), categories != "consequences") %>% 
  group_by(categories, state, date) %>% 
  mutate(
    mean_hits = mean(hits, na.rm = TRUE)
  ) %>% 
  ggplot() + 
  geom_line(aes(date, mean_hits, group = categories, color = categories)) +
  geom_line(aes(date, cases)) +
  coord_cartesian(ylim = c(0, 100)) + 
  facet_wrap(vars(state))
```


# TO DOs
- reorder the states (figure out)
- create dashboard
- rescrape missing states